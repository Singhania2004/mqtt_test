<!DOCTYPE html>
<html>
<head>
  <title>Manhole MQTT Test</title>
</head>
<body>

<h2>Manhole Monitoring (MQTT)</h2>

<p>
  Status:
  <span id="status">OFFLINE</span>
</p>

<pre id="output">Waiting for data...</pre>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>
  const options = {
    username: "DTech",
    password: "DTech123",
    clean: true,
    connectTimeout: 4000
  };

  const client = mqtt.connect(
    "wss://acb78c56e1724bec8438e8707d372406.s1.eu.hivemq.cloud:8884/mqtt",
    options
  );

  let lastMessageTime = 0;

  client.on("connect", () => {
    console.log("Connected");
    client.subscribe("manhole/data");
  });

  client.on("message", (topic, message) => {
    lastMessageTime = Date.now();
    document.getElementById("status").innerText = "ONLINE";

    const data = JSON.parse(message.toString());
    document.getElementById("output").innerText =
      JSON.stringify(data, null, 2);
  });

  setInterval(() => {
    if (lastMessageTime === 0) return;

    const now = Date.now();

    if (now - lastMessageTime > 5000) {
      document.getElementById("status").innerText = "OFFLINE";
    }
  }, 1000);

  client.on("error", (err) => {
    console.error("‚ùå MQTT Error", err);
  });
</script>

</body>
</html>
